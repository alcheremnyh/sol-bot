# API для множественных токенов

## Обзор

API теперь поддерживает кэширование и отслеживание множественных токенов. Каждый запрошенный токен автоматически добавляется в кэш и отслеживается.

## Как это работает

1. **Первый запрос токена** - данные запрашиваются у RPC и сохраняются в кэш
2. **Последующие запросы** - данные возвращаются из кэша (мгновенно)
3. **Автообновление** - все токены в кэше обновляются каждые 30 секунд (или указанный интервал)
4. **Отслеживание** - для каждого токена ведется статистика:
   - Количество запросов
   - Время первого запроса
   - Время последнего обновления

## Endpoints

### 1. GET /holders/:mint

Получить количество держателей токена.

**Пример:**
```bash
curl https://sminem.fun/api-sol/holders/9AvytnUKsLxPxFHFqS6VLxaxt5p6BhYNr53SD2Chpump
```

**Ответ:**
```json
{
  "mint": "9AvytnUKsLxPxFHFqS6VLxaxt5p6BhYNr53SD2Chpump",
  "holders": 1234,
  "timestamp": 1702324800,
  "cached": true
}
```

- `cached: false` - первый запрос (данные только что получены из RPC)
- `cached: true` - данные из кэша

### 2. GET /tokens

Получить список всех отслеживаемых токенов с статистикой.

**Пример:**
```bash
curl https://sminem.fun/api-sol/tokens
```

**Ответ:**
```json
[
  {
    "mint": "9AvytnUKsLxPxFHFqS6VLxaxt5p6BhYNr53SD2Chpump",
    "holders": 1234,
    "last_updated": 1702324800,
    "request_count": 15,
    "first_seen": 1702320000
  },
  {
    "mint": "So11111111111111111111111111111111111111112",
    "holders": 5678,
    "last_updated": 1702324850,
    "request_count": 3,
    "first_seen": 1702321000
  }
]
```

### 3. GET /stats

Получить статистику кэша.

**Пример:**
```bash
curl https://sminem.fun/api-sol/stats
```

**Ответ:**
```json
{
  "total_tracked_tokens": 5,
  "total_requests": 42,
  "cache_size_bytes": 1024
}
```

### 4. GET /health

Проверка здоровья API.

**Пример:**
```bash
curl https://sminem.fun/api-sol/health
```

## Примеры использования

### Запрос разных токенов

```bash
# Пользователь 1 запрашивает токен A
curl https://sminem.fun/api-sol/holders/TOKEN_A

# Пользователь 2 запрашивает токен B
curl https://sminem.fun/api-sol/holders/TOKEN_B

# Пользователь 3 запрашивает токен A (получит из кэша)
curl https://sminem.fun/api-sol/holders/TOKEN_A

# Все токены теперь отслеживаются и обновляются автоматически
```

### Проверка отслеживаемых токенов

```bash
# Посмотреть все отслеживаемые токены
curl https://sminem.fun/api-sol/tokens | jq '.'

# Посмотреть статистику
curl https://sminem.fun/api-sol/stats | jq '.'
```

## Автоматическое обновление

Все токены в кэше автоматически обновляются каждые 30 секунд (или указанный интервал через `--cache-ttl`).

- Первый запрос токена → данные из RPC
- Последующие запросы → данные из кэша
- Фоновая задача → обновление всех токенов каждые 30 секунд

## Производительность

- **Кэшированные запросы**: <1ms (мгновенно)
- **Первые запросы**: ~2-5 секунд (зависит от RPC)
- **Обновление кэша**: в фоне, каждые 30 секунд
- **RPC нагрузка**: минимизирована (1 запрос в 30 сек на токен)

## Логирование

API логирует:
- Добавление нового токена в кэш
- Кэш-хиты (с номером запроса)
- Обновление токенов в фоне
- Ошибки при обновлении

Примеры логов:
```
Added TOKEN_A to cache (total tracked tokens: 1)
Cache hit for TOKEN_A (request #5), returning cached data
Refreshed cache for mint TOKEN_A: 1234 holders
```

