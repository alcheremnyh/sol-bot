name: Docker Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: prod
    name: Build and Deploy Solana Holder Bot

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Stop and remove existing container
        run: |
          docker stop solana-holder-bot-prod || true
          docker rm solana-holder-bot-prod || true

      - name: Remove old images to force rebuild
        shell: bash
        run: |
          docker rmi solana-holder-bot:latest || true
          for img in $(docker images solana-holder-bot -q); do docker rmi -f $img || true; done

      - name: Clean Docker build cache
        run: |
          docker builder prune -af || true
          docker system prune -f || true

      - name: Build Docker image (no cache, pull latest base)
        run: |
          docker build \
            --no-cache \
            --pull \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=$(git rev-parse --short HEAD) \
            -t solana-holder-bot:latest \
            -t solana-holder-bot:$(date +%s) \
            .

      - name: Run Docker container
        env:
          MINT_ADDRESS: ${{ vars.MINT_ADDRESS || '9AvytnUKsLxPxFHFqS6VLxaxt5p6BhYNr53SD2Chpump' }}
          RPC_URL: ${{ vars.RPC_URL || 'https://api.mainnet-beta.solana.com' }}
          INTERVAL: ${{ vars.INTERVAL || '30' }}
          CACHE_TTL: ${{ vars.CACHE_TTL || '30' }}
          MAX_RETRIES: ${{ vars.MAX_RETRIES || '3' }}
          TIMEOUT: ${{ vars.TIMEOUT || '30' }}
        run: |
          docker run -d \
            --name solana-holder-bot-prod \
            --restart unless-stopped \
            -p 56789:56789 \
            -e MINT_ADDRESS="${MINT_ADDRESS}" \
            -e RPC_URL="${RPC_URL}" \
            -e INTERVAL="${INTERVAL}" \
            -e CACHE_TTL="${CACHE_TTL}" \
            -e MAX_RETRIES="${MAX_RETRIES}" \
            -e TIMEOUT="${TIMEOUT}" \
            solana-holder-bot:latest \
            ./solana-holder-bot \
              "${MINT_ADDRESS}" \
              --rpc-url "${RPC_URL}" \
              --interval "${INTERVAL}" \
              --api \
              --api-port 56789 \
              --cache-ttl "${CACHE_TTL}" \
              --max-retries "${MAX_RETRIES}" \
              --timeout "${TIMEOUT}"

      - name: Verify container is running
        run: |
          sleep 5
          docker ps | grep solana-holder-bot-prod
          docker logs solana-holder-bot-prod --tail 20

      - name: Test API endpoint
        run: |
          sleep 3
          curl -f http://localhost:56789/health || echo "API health check failed"

      - name: Clean up old images and cache
        run: |
          docker image prune -af || true
          docker builder prune -af || true
